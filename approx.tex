\section{Another Try on ``Zones and constraints''}

In order to implement an untimed teacher using a timed teacher, we need a
basic machinery to determine whether an untimed behavior is feasible, i.e.,
whether it can be derived from a timed word. This can be done using
well-established techniques for manipulating difference-bound matrices
(DBMs) that are in standard use for analyzing timed
automata~\cite{Di89,BengtssonY03}.
In this section, we describe an adaptation of such techniques to
our setting.

Let $\beta$ be an untimed behavior in canonical form:
\begin{eqnarray*}
\beta & = & \emptyset \uttrans{i_1}{o_1}{\rho_1} X_1  \cdots X_{k-1} \uttrans{i_k}{o_k}{\rho_k} X_k.
\end{eqnarray*}
We would like to determine for which values $d_1, \ldots , d_{k+1}$
a corresponding timed behavior
\[
\tvals_0 \dtrans{d_1} \tvals'_0 \uttrans{i_1}{o_1}{\rho_1}
\quad \cdots \quad
\dtrans{d_k} \tvals'_k \uttrans{i_k}{o_k}{\rho_k} \tvals_k
\dtrans{d_{k+1}} \tvals'_{k+1}
%% \uttrans{\toevent{x_i}}{o_{n+1}}{\rho_n}
\]
is possible. We solve this problem by producing a constraint over the
values $d_1, \ldots , d_{k+1}$. In order to use DBM techniques, we first
change representation by letting
$t_j = d_1 + \cdots + d_j$ for $j = 1 , \ldots, k+1$. Intuitively, $t_j$ is
the time of occurrence of the $j$th transition in $\beta$.
We now associate with $\beta$ a conjunction of difference constraints over
$t_1, \ldots, t_{k+1}$, denoted $\Constraints{\beta}$, consisting of
\todobj{We assume that delays are always non-zero. Check how this is said in
  the paper}
\begin{itemize}
%% \item
%% $0 < t_1 \leq d_{\max}$,
%% \item
%% for each index $j < k$:  $0 <  t_{j+1} - t_j \leq d_{\max}$,
\item
for each index $j$ with $1 \leq j \leq k$:  $0 <  t_{j+1} - t_j$,
\item
for each timeout event $i_j = \toevent{x_l}$: $t_j - t_l = \rho_l(x_l)$,
\item
for each clock $x_l$ that is started but does not timeout: $t_j -t_l < \rho_l(x_l)$,
where $j$ is the largest index such that $x_l \in X_j$,
%% \item
%% for each pair of distinct indices $j$ and $l$ with $i_j, i_l \in I$: $\Frac{t_j} \neq \Frac{t_l}$ 
%% (to express that the fractional parts of $t_j$ and $t_l$ are different).
\end{itemize}
By standard DBM techniques, we can check whether $\Constraints{\beta}$ is satisfiable by saturating it (i.e., closing it under implied constraints, which
will always be of form
$n < t_j - t_l < m$ or $t_j - t_l = m$ for integers $n,m$), and checking that
all such differences allow $t_{j+1} - t_j$ be positive for each $j$.
We infer that $\beta$ is feasible iff $\Constraints{\beta}$ is satisfiable.
Moreover, if $\beta$ is feasible, it is easy to see that there is a solution
such that $\Frac{t_j} \neq \Frac{t_l}$ for each pair of distinct indices $j$ and $l$ with $i_j, i_l \in I$.

From the saturated version of $\Constraints{\beta}$, we also derive a constraint,
denoted $\Zone{\beta}$,
which characterizes the possible timer valuations $\tvals_k$ in a timed
behavior of the above form.  The constraint $\Zone{\beta}$
contains for each pair of timers $x_i,x_j$ in $X_k$ the conjunct
\[
(m + \rho_j(x_j) - \rho_i(x_i)) < \tvals_k(x_j) -\tvals_k(x_i) < (n + \rho_j(x_j) - \rho_i(x_i))
\]
whenever the saturated version of $\Constraints{\beta}$ contains the conjunct
\(
m < t_j - t_i < n
\).
(This can be derived using
$\tvals_k(x_j) = \rho_j(x_j) - (t_k - t_j)$
and
$\tvals_k(x_i) = \rho_i(x_i) - (t_k - t_i)$).

We can derive the following lemmas.

\begin{lemma}
\label{lemma: feasibility concatenation}
Suppose $\beta, \beta'$ are untimed behaviors such that
$\Zone{\beta} = \Zone{\beta'}$. Let $\gamma$ be any untimed behavior.
Then $\beta \cdot \gamma$ is feasible iff $\beta' \cdot \gamma$ is feasible.
\end{lemma}

\begin{lemma}
\label{lemma finitely many zones}
$\{ \Zone{\beta} \mid \beta \mbox{ feasible untimed behavior of } \M \}$ is finite.
\end{lemma}
\begin{proof}
  An MMT only has a finite number of timers that can only be set to a finite number of integer values. Since in an MMT the values of timers can only decrease, their values are bounded, so that only finitely many integers may appear in the conjuncts of $\Zone{\beta}$. This the set of possible $\Zone{\beta}$ is finite.
\end{proof}

Let $\beta$ be a feasible untimed behavior and let $x \in X$ be a timer. Then we say that $x$ is \emph{expirable} after $\beta$
if there exists a valuation in $\Zone{\beta}$ in which $x$ is minimal.

\begin{lemma}
\label{expirable}
Suppose $\beta$ is a feasible untimed behavior with $\Last{\beta} = Y$ and $Y \uttrans{\toevent{x}}{o}{\rho} Y'$ is an untimed behavior.
Then $x$ is expirable after $\beta$ iff $\beta \uttrans{\toevent{x}}{o}{\rho} Y'$ is feasible.
\end{lemma}


\todofv{Move next lemma to earlier section}

\begin{lemma}
\label{not timed}
Suppose $\M, \N$ are MMTs with $\M \not\approx_{\mathit{timed}} \N$.
Then there exists a transparent timed word $w$ of $\M$ that is not a timed word of $\N$.
\end{lemma}



\section{Approximating the Nerode Equivalence}
\label{sec:approx}

In this section, we present an approximation of the Nerode equivalence on
untimed behaviors
defined in Definition~\ref{def:nerode}. This
approximated equivalence can be inferred using a finite set of membership
queries, and therefore be used as a basis for a learning algorithm,
analogously to the use of an approximated Nerode equivalence in
$L^*$~\cite{Ang87}.
Intuitively, it seems natural to parameterize such an equivalence by
a finite set $V$ of untimed input words (hereafter often
called {\em input suffixes}), by letting
untimed behaviors $\beta$ and $\beta'$ be equivalent
iff there exists a bijection $f_0 : X \to X'$ between the timers that are'active after $\beta$ and $\beta'$, respectively, such that whenever
$\untimedinputword(\gamma) \in V$, then
$\beta\cdot\gamma \in S$ iff 
$\beta'\cdot f_0(\gamma') \in S$, where $\gamma'$ is obtained by
renaming timers that are assigned in $\gamma$ in an appropriate way.
%% such that for any untimed behavior
%% $\gamma$ with $\untimedinputword(\gamma)\in V$:
%% if $\beta \cdot \gamma \in S$ then there exists an isomorphism $f$ that extends $f_0$ such that $\beta' \cdot f(\gamma) \in S$, and vice versa.
%% (b) if $\beta' \cdot \gamma \in S$ then there exists an isomorphism $f$ that extends $f_0^{-1}$ such that $\beta \cdot f(\gamma) \in S$.
In order to make this approach work, we must let the sets $V$ of suffixes that
parameterize the equivalence be
closed under permutation of timers that are active after a prefix $\beta$.
To illustrate why, consider a simple MMT, which can perform the untimed runs
\(
q_0 \uttrans{i_1}{o_1}{x_1:= 5} q_2
\)
or
\(
q_0 \simpleuttrans{i_1}{o_1} q_0 \uttrans{i_2}{o_2}{x_1:= 5} q_2
\),
and that from $q_2$ it can perform
\(
q_2 \simpleuttrans{\toevent{x_1}}{o_3} q_3
\).
The canonical untimed behaviors corresponding to the first two
untimed runs are
\(
\emptyset \uttrans{i_1}{o_1}{x_1:= 5} \set{x_1}
\)
and
\(
\emptyset \uttrans{i_1}{o_1}{} \emptyset \uttrans{i_2}{o_2}{x_2:= 5} \set{x_2}
\).
In order to let these two behaviors be equivalent we must discover that
timer $x_1$ can expire after the first one, and that
timer $x_2$ can expire after the second one. Since these two timers
have the same rules, the set $V$ of suffixes must
include the effects of the timeout events of form $\toevent{x_i}$ for any
timer $x_i$ that is assigned in a prefix, otherwise we
may fail to overapproximate the Nerode equivalence of Definition~\ref{def:nerode}.

Let us introduce notation to make the subsequent development more convenient. 
Recall that an untimed behavior is \emph{canonical} when, for each $j$,
the timer that is updated in the $j$-th event (if any) is equal to $x_j$.
It is {\em lean} if it is canonical and
includes only timers that expire during the behavior. 
Since the sequence of timer sets in a lean behavior is
uniquely determined by the labels on its transition, we can
denote a lean behavior simply by the sequence
$\utlabel{i_1}{o_1}{\rho_1} \cdots \utlabel{i_n}{o_n}{\rho_n}$ of its labels.
If some $\rho_j$ is empty, can omit it. In particular, the last assignment of
any lean behavior is always empty.
For behaviors that are to be appended as suffixes, we need to distinguish
timers that are assigned in the suffix from timers that are assigned in a prefix.
Therefore, extend the set of timers by the set $Y = \set{y_1,y_2,\ldots}$ of
{\em suffix timers}, which is disjoint from $X$.
Let $\toeventsof{Y}$ be the set of timeout events of form
$\toevent{y_i}$ for $y_i \in Y$, and let
$\extextinputs$ be $I \cup \toevents \cup \toeventsof{Y}$.
Define a {\em lean suffix behavior} to be a sequence
$\utlabel{i_1}{o_1}{\rho_1} \cdots \utlabel{i_m}{o_m}{\rho_m}$ of input/output/assignment triples,
in which each $i_j$ is in $\extextinputs$, 
each $\rho_j$ may assign only to the timer $y_j$,
each timeout event occurs at most once,
and all assigned timers in $Y$ expire sometime after their assignment.

For integer $k \geq 0$, let $\suffmap{k}$ be the injective mapping on
$Y$ which maps each $y_j$ to $x_{j+k}$.  We apply mappings of form
$\suffmap{k}$ to lean suffix behaviors in the natural way.

Let $\beta$ be a lean behavior. We say that 
a lean suffix behavior $\gamma$ is a {\em $\beta$-suffix} if
there is a canonical behavior $\beta'$ with $\beta \sqsubseteq \beta'$ such that
$\beta'\cdot\suffmap{|\beta|}(\gamma)$ is a lean behavior. In this case we
use $\beta;\gamma$ to denote $\beta'\cdot\suffmap{|\beta|}(\gamma)$.
Note that the inputs from $\toevents$ in a $\beta$-suffix may concern only
the timers $\set{x_1, \ldots, x_{|\beta|}}$.

Let an {\em input suffix} be a sequence of elements in $\extextinputs$.
A set $V$ of input suffixes is {\em adequate} if it is closed under permutations
on $X$ and includes all input suffixes of length one.
For an adequate set $V$ of input suffixes, and a lean behavior $\beta$,
let $\apprsuffixbehs{S}{\beta}{V}$ be the set of $\beta$-suffixes $\gamma$
with $\untimedinputword(\gamma) \in V$.
Let $\apprgetmemorable{S}{\beta}{V}$ be the set of timers $x_i$ in
$x_1 , \ldots x_{|\beta|}$ whose corresponding timeout event
(of form $\toevent{x_i}$) occurs (as an input) in some untimed behavior in
$\apprsuffixbehs{S}{\beta}{V}$.
Let $\apprgetassignment{S}{\beta}{V}$ map each timer $x_i$ in
$\apprgetmemorable{S}{\beta}{V}$ to the unique positive integer to which it
is assigned in the $i$th transition of $\beta$.


%% \todobj{Maybe we should point out that two prefixes $\beta$ and $\beta'$
%%   can be equivalent even if they assign corresponding timers to different
%%   values. However, timers assigned in corresponding suffixes must
%%   be assigned the same values.}

%% Let us introduce the {\em generic timeout event} $\toevent{p}$, where $p$w can
%% be regarded as a formal parameter,
%% which can be instantiated to an arbitrary timout event.
%% Let $(I \cup \set{\toevent{p}})^*$ be the set of
%% {\em generic untimed input words}.
%% An {\em instance} of a generic untimed input word is an untimed input
%% word obtained by replacing each generic timeout event
%% $\toevent{p}$ by a concrete timeout event.
%% For a set $V$ of generic untimed input words, let $\instancesof{V}$ be the
%% set of instances of words in $V$. For a canonical untimed
%% behavior $\beta$, let $\apprsuffixbehs{S}{\beta}{V}$ be the set of untimed behaviors
%% $\gamma$ with $\untimedinputword(\gamma) \in \instancesof{V}$ such that
%% $\beta\cdot\gamma$ is a canonical untimed behavior in $S$. Let
%% $\apprgetmemorable{S}{\beta}{V}$ be the set of timers $x_i$ in
%% $x_1 , \ldots x_{|\beta|}$ whose corresponding timeout event
%% (of form $\toevent{x_i}$) occurs (as an input) in some untimed behavior in
%% $\apprsuffixbehs{S}{\beta}{V}$.
%% Let $\apprgetassignment{S}{\beta}{V}$ map each timer $x_i$ in
%% $\apprgetmemorable{S}{\beta}{V}$ to the unique positive integer to which it
%% is assigned in the $i$th transition of that behavior.


%% Let $\suffbij{\beta}{\beta'}$ be the partial injective mapping
%% on timers that maps each
%% timer $x_i$ with $i > |\beta|$ to $x_{i + |\beta'| - |\beta|}$.
%% Intuitively, $\suffbij{\beta}{\beta'}$ maps a timer that is assigned 
%% in a transition of $\gamma$, where $\gamma$ is a suffix of the canonical
%% untimed behavior $\beta \cdot \gamma$, to the corresponding timer of
%% the canonical untimed behavior $\beta'\cdot\gamma$.
%% For two partial mappings $f$, $g$ on $X$, we let $f \sqcup g$ be their
%% union. \todobj{Does this need to be further clarified?}

%% \todobj{An illustrating example would help the reader here}

\todobj{We really need a few examples here}

We can now defined the approximated Nerode equivalence, which is parameterized
on an adequate set of lean input suffixes.

\begin{definition}
  \label{def:approx-nerode}
Let $S$ be a timer language \todobj{Define this},
let $\beta$ and $\beta'$ be canonical untimed behaviors in $S$,
and let  $V$ be an adequate set of lean input suffixes.
Let $f : \apprgetmemorable{S}{\beta}{V} \to \apprgetmemorable{S}{\beta'}{V}$
be a bijection
from $\apprgetmemorable{S}{\beta}{V}$ to $\apprgetmemorable{S}{\beta'}{V}$.
Then $\beta$ and $\beta'$ are \emph{equivalent wrp $V$} under $f$, written
$\beta \equiv_{S,V}^f \beta'$ iff
\[
\gamma \in \apprsuffixbehs{S}{\beta}{V}
\qquad \mbox{iff} \qquad
f(\gamma) \in \apprsuffixbehs{S}{\beta'}{V}
\]
\end{definition}
Intuitively, $\beta \equiv_{S,V}^f \beta'$ means that $\beta$ and $\beta'$
allow the same suffixes with inputs in $V$, after renaming
timers assigned in $\beta$ by $f$.
We write $\beta \equiv_{S,V} \beta'$ to denote that
$\beta \equiv_{S,V}^f \beta'$ for some
$f : \apprgetmemorable{S}{\beta}{V} \to \apprgetmemorable{S}{\beta'}{V}$.


\todobj{What theorems should we prove about this approximating equivalence?
  We should make the definition of Nerode use the same notation, whenever
  reasonable, to make this easier}


