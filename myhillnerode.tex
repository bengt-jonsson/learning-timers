\subsection{A Myhill Nerode Theorem for MMTs}

\begin{definition}
\label{def:timer language}
A \emph{timer language} over $I$ and $O$ is a nonempty set 
$S$ of feasible untimed behaviors in canonical form over $I$ and $O$ that satisfies the following five properties:
\begin{itemize}
\item
\emph{no initial timers}: $\beta \in S \Rightarrow \Head{\beta} = \emptyset$,
\item
\emph{prefix closed}: $\beta \cdot \gamma \in S \Rightarrow \beta \in S$,
\item
\emph{behavior deterministic}:
$\beta \xrightarrow{i/o_1, \rho_1} X_1 \in S \wedge \beta \xrightarrow{i/o_2, \rho_2} X_2 \in S \Rightarrow o_1 = o_2 \wedge \rho_1 = \rho_2 \wedge X_1 = X_2$,
\item
\emph{input complete}:
$\beta \in S \wedge i \in I \Rightarrow \exists o, \rho, Y : \beta \xrightarrow{i/o, \rho} Y \in S$,
and
\item
\emph{timeout complete}:
$\beta \in S \wedge x \mbox{ expirable after } \beta \Rightarrow
\exists o, \rho, Y: \beta \xrightarrow{\toevent{x}/o, \rho} Y \in S$.
\end{itemize}
\end{definition}

\begin{definition}
\label{def:nerode}
Let $S$ be a timer language.
Suppose $\beta$ and $\beta'$ are behaviors in $S$ with $\Last{\beta} = X$ and $\Last{\beta'} = X'$.
Then $\beta$ and $\beta'$ are \emph{equivalent}, written $\beta \equiv_S \beta'$, iff there exists a bijection
$f_0 : X \to X'$ such that for any untimed behavior $\gamma$:
(a) if $\beta \cdot \gamma \in S$ then there exists an isomorphism $f$ that extends $f_0$ such that $\beta' \cdot f(\gamma) \in S$, and conversely,
(b) if $\beta' \cdot \gamma \in S$ then there exists an isomorphism $f$ that extends $f_0^{-1}$ such that $\beta \cdot f(\gamma) \in S$.
We write $[\beta]$ to denote the equivalence class of $\beta$ with respect to $\equiv_S$.
\end{definition}

\begin{theorem}
\label{Myhill Nerode}
Let $S$ be a timer language.
Then there exists an MMT with feasible untimed behaviors $T$ and $\can{T} = S$ iff 
$\equiv_S$ has finitely many equivalence classes (finite index).
\end{theorem}
\begin{proof} 

``$\Rightarrow$'' Let $\M$ be an MMT, let $T$ be its set of feasible untimed behaviors, and let $S = \can{T}$.
Then it follows from the definitions, Lemma~\ref{feasible plus input is feasible} and Lemma~\ref{expirable} that $S$ is a timer language.
Suppose that $\beta, \beta' \in S$.
Then there exist (unique) $\delta, \delta \in T$ with
$\can{\delta}=\beta$ and $\can{\delta'}=\beta'$.
Suppose $\delta$ and $\delta'$ lead to the same state $q$ of $\M$ and moreover $\Zone{\delta} = \Zone{\delta'}$.
We claim that $\beta \equiv_S \beta'$.
Since $\beta$ and $\delta$ are isomorphic, there exists an isomorphism $g = g_0 ,\ldots, g_k$ from $\beta$ to $\delta$.
Similarly, since $\beta'$ and $\delta'$ are isomorphic, there exists an isomorphism $g' = g'_0 ,\ldots, g'_l$ from $\beta'$ to $\delta'$.
Let $f_0 = (g'_l)^{-1} \circ g_k$.
Suppose that, for some untimed behavior $\gamma$, $\beta \cdot \gamma \in S$.
Then there exists an untimed behavior $\zeta$ such that $\delta \cdot \zeta \in T$ and $\can{\delta \cdot \zeta} = \beta \cdot \gamma$.
Moreover, there exists an isomorphism $h = g_k ,\ldots, g_m$ from $\gamma$ to $\zeta$.
Since $\delta \cdot \zeta$ is a feasible behavior in $T$, it follows by Lemma~\ref{lemma: feasibility concatenation} that
$\delta' \cdot \zeta$ is a feasible behavior in $T$.
Thus there exists an untimed behavior $\gamma'$ such that $\can{\delta' \cdot \zeta} = \beta' \cdot \gamma' \in S$.
Moreover, we may construct an isomorphism $h' = g'_l ,\ldots, g'_n$ from $\gamma'$ to $\zeta$.
Then $f = (g'_l)^{-1} \circ g_k \cdots (g'_n)^{-1} \circ g_m$ is an isomorphism from $\gamma$ to $\gamma'$ that extends $f_0$.
We then have $\beta' \cdot f(\gamma) \in S$, as required.
Clause (b) of Definition~\ref{def:nerode} follows by a symmetric argument.
Since $\M$ only has finitely many states and by Lemma~\ref{lemma finitely many zones} the number of zones of feasible
untimed behaviors of $M$ is finite, it follows that $\equiv_S$ has finite index.

``$\Leftarrow$'' 
\todofv{This direction still needs work, but I know how to do it. Easy once you allow renaming of timers.}
Suppose $S$ is a timer language with finite index.
Let MMT $\M = (I, O \cup \{ \perp \}, Q, q_0, \vars, \delta, \lambda, \remap)$ be defined as follows:
\begin{itemize}
\item
$\perp$ is a special, fresh output event.
\item
$Q = \{ ( [\beta], \Post_{\uncan{\beta}}) \mid \beta \in S \}$.
\item
$q_0 = ([\emptyset], Z_0)$. (Note that $\emptyset \in S$ since $S$ is nonempty, prefix closed, and all untimed behaviors in $S$ start
with the empty set of timers; $Z_0$ is the unique zone for the empty set of variables.)
\item
$\varsof{([\beta], Z)} = \domof{Z}$.
\item
(rest needs doing). Let $\beta \in S$ and $i \in I$. Then, since $S$ is both input complete and behavior deterministic, there exist unique
$o$, $\rho$ and $Y$ such that $\beta' = \beta \xrightarrow{i/o, \rho} Y \in S$.
We define $\delta([\beta],i) = [\beta']$, $\lambda([\beta],i) = o$, and $\remap([\beta],i) = \rho$.
\item
Assume $\beta \in S$ and $x\in \Last{\beta}$ expirable after $\beta$. 
Then, since $S$ is both timeout complete and behavior deterministic, there exist unique
$o$, $\rho$ and $Y$ such that $\beta' = \beta \xrightarrow{\toevent{x}/o, \rho} Y \in S$.
We define $\delta([\beta],\toevent{x}) = [\beta']$, $\lambda([\beta],\toevent{x}) = o$, and $\remap([\beta],\toevent{x}) = \rho$.
\item
Assume $\beta \in S$ and $x \in \Last{\beta}$ not expirable after $\beta$.
We define $\delta([\beta],\toevent{x}) = [\beta]$, $\lambda([\beta],\toevent{x}) = \perp$, and $\remap([\beta],\toevent{x}) = \rho_0$, where $\domof{\rho_0} = \emptyset$.
\end{itemize}
It is routine to verify that $\M$ is a well-defined MMT whose set of feasible untimed behaviors equals $S$.
\end{proof}
