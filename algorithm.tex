\section{Learning algorithm}  
\label{algorithm}
In this section, we consider another instance of Angluin's MAT framework.
Again, the teacher knows an MMT $\M$ but now the learner poses membership queries
to learn the \emph{untimed} behaviors of $\M$, and if an equivalence query fails then the counterexample is an \emph{untimed} behavior of $\M$.
%
We will show how an untimed teacher for MMTs can be implemented using a timed teacher.
%and how an untimed learner for MMTs can be implemented using a Mealy machine learner.
%This will allow us to use existing algorithms for learning Mealy machines,
%as implemented for instance in LearnLib \cite{RSBM09}, as part of an algorithm to learn MMTs. 



\subsection{An untimed MAT framework for MMTs}
Given the equivalence of the timed and the untimed semantics of MMTs, it is natural to also 
consider an untimed setting, in which a learner tries to construct an MMT based on membership queries for untimed behaviors.

In the untimed framework, the teacher does not reveal the names of the timers that occur in untimed behaviors, 
and brings untimed behaviors into a ``canonical'' form, so that a learner can only observe these behaviors up to isomorphism.
Let us formalize this idea.
Suppose $\beta$ be an untimed behavior in which transitions update at most one timer.
We say that $\beta$ is in \emph{canonical form} if, for each $j$, the timer that is updated in the $j$-th event
(if any) is equal to $x_j$.
For each untimed behavior $\beta$ in which transitions update at most one timer, there is a unique untimed behavior
$\beta'$ in canonical form that is isomorphic to $\beta$.
We write $\can{\beta}$ to denote this $\beta'$.

Suppose the $\beta$ is an untimed behavior. Then it may occur that somewhere in $\beta$ a timer $x$ is started that never times out.
In such a case, we may obtain a new untimed behavior by not starting $x$ and removing subsequent occurrences of $x$ in $\beta$ (possibly up to the point
where $x$ is restarted).
In the untimed behavior $\emptyset \xrightarrow{i/o,~ x:=1 } \{ x\} \xrightarrow{i/o,~ y:=60 } \{ x, y\}$, for instance, we may remove timer $x$
and obtain $\emptyset \xrightarrow{i/o } \emptyset \xrightarrow{i/o,~ y:=60 } \{ y\}$.
Similarly, we may remove the first use of timer $x$ in the untimed behavior 
$\emptyset \xrightarrow{i/o,~ x:=1 } \{ x\} \xrightarrow{i/o,~ x:=5 } \{ x\} \xrightarrow{\toevent{x}/o} \emptyset$ and obtain
$\emptyset \xrightarrow{i/o } \emptyset \xrightarrow{i/o,~ x:=5 } \{ x\} \xrightarrow{\toevent{x}/o} \emptyset$.
Write $\beta \sqsubseteq \beta'$ if $\beta$ can be obtained from $\beta'$ by removing zero or more of timers that do not timeout.
Observe that $\sqsubseteq$ is a partial order.
We call $\beta$ a \emph{partial} untimed behavior of MMT $\M$ iff $\M$ has an untimed behavior $\beta'$ such that $\beta \sqsubseteq \beta'$.
In the untimed framework, the teacher replies with partial untimed behaviors of $M$, brought in canonical form.

An \emph{untimed input word} over $I$ is a sequence $u = i_1 \cdots i_k$ over $\extinputs$ such that (1)
for all indices $j, l$, $i_j = \toevent{x_l}$ implies $l < j$, and (2) each timer occurs at most once in a timeout event.
The first condition  says that if a timer expires it must have been set in a previous event, and the second condition  expresses that
each timer may expire at most once.
Let $\beta$ be an untimed behavior in canonical form.
We can associate a unique input word $\untimedinputword(\beta)$ to $\beta$ by removing all the output events,
updates, and timer sets from $\beta$.
\iflong
\begin{figure}
\begin{center}
 \begin{tikzpicture}[>=stealth]
            \draw [thick] (0,0) rectangle (1.2,3.5) node[midway] {Learner};
            \draw [thick] (7,0) rectangle (8.3,3.5) node[midway] {Teacher};
            \draw [->] (1.2,3) -- (7,3) node[midway,below] {MQs};
            \draw (1.2,3) -- (7,3) node[midway,above] {\small untimed input word $u$};
            \draw [<-] (1.2,2.5) -- (7,2.5) node[midway,below] {\small canonical feasible partial untimed behavior};
             \draw (4.15,2) node {\small $\beta$ of $\M$ with $\untimedinputword(\beta)$ maximal prefix of $u$};
            \draw [->] (1.2,1) -- (7,1) node[midway,below] {EQ};
            \draw (1.2,1) -- (7,1) node[midway,above] {\small hypothesis $\CH$};
            \draw [<-] (1.2,0.5) -- (7,0.5) node[midway,below] {\small {\bf yes} \emph{or} {\bf no}+ counterexample $\beta$};
        \end{tikzpicture}
\end{center}    
\caption{Untimed MAT framework}
\label{fig:untimed MAT}
\end{figure}
\fi

Our untimed learning setup, illustrated in Figure~\ref{fig:untimed MAT}, is similar to the timed setup:
again the teacher knows an MMT $\M$ and the learner initially only knows the set of inputs $I$ of $\M$.
Again, the learer may pose membership and equivalence queries.
But now a \emph{membership query} consists of an untimed input word $u$ over $I$.
The teacher replies with a maximal feasible partial untimed behavior $\beta$ of $M$ (in canonical form) such that
$\untimedinputword(\beta)$ is a prefix of $u$.
With an \emph{equivalence query}, the learner asks if a hypothesis $\CH$ with inputs $I$ is correct.
Upon receiving $\CH$, the teacher answers \emph{yes} if $\CH \approx_{\mathit{untimed}} \M$.
Otherwise it answers \emph{no} and supplies a counterexample, which now is a feasible untimed behavior $\beta$ (in canonical form) that
is a partial untimed behavior of $\M$ but not of $\CH$.

\iflong
\input{reachability}
\else
Note that for an untimed behavior $\beta$, the set $\zone{\beta}$ of valuations that can be reached with a timed behavior $\sigma$ with $\untime(\sigma) = \beta$ can be symbolically represented using DBMs \cite{Di89}.
We can do this since the transition relations $\xrightarrow{d}$ and $\xrightarrow{i_1/o_1, \rho_1}$ can be decomposed 
into elementary operations on DBMs such as reset, conjunction, and delay successors \cite{BengtssonY03}.
This allows us to compute whether an untimed behavior $\beta$ is feasible ($\zone{\beta}$ is empty), and
whether a timer $x$ may expire after $\beta$ ($\zone{\beta}$ contains a valuation in which $x$ is minimal).
\fi

\subsection{Constructing an untimed teacher from a timed teacher}
We will now show how to construct a teacher for the untimed setting from a teacher for the timed setting.

Suppose the untimed teacher receives a membership query, consisting of an untimed input word
$u = i_1 \cdots i_k$.
By induction on the length of $u$, 
we construct a response for $u$, that is a feasible partial untimed behavior $\beta$ of $M$ (in canonical form)
with $\untimedinputword(\beta)$ a maximal prefix of $u$
If $k=0$, then we take $\beta = \emptyset$.
For the induction step, suppose that $k>0$.
Let $\beta$ be the response for $i_1 \cdots i_{k-1}$.
If the length of $\beta$ is less than $k-1$, then the answer for $u$ is also $\beta$.
If $i_k = \toevent{x}$ for some timer $x$ that is not expirable after $\beta$ then there exists no feasible partial untimed behavior
with untimed input word $u$. This means that $\beta$ is maximal and the teacher returns answer $\beta$.
Otherwise, there exists a feasible behavior that extends $\beta$ with input $i_k$. 
%continue here
We compute
a corresponding transparent timed behavior, extract a timed input word from it and pose this as a query to the timed learner.
Since the resulting timed word is transparent, it has a unique causality map, so we know
which timeouts and outputs occur.
Using a series of lookahead queries, we can determine which timers are active at each point during the run,
and which timers have been set that have not yet timed out.
Based on this, the untimed MMT teacher may answer the membership query.

Once we have implemented membership queries, implementing equivalence queries is easy.
Suppose that the untimed teacher receives an equivalence query $\CH$.
Then we just forward this query to the timed teacher.
If the timed teacher answers \emph{yes} then $\CH \approx_{\mathit{timed}} \M$.
In this case, by Theorem~\ref{timedimpliesuntimed}, $\CH \approx_{\mathit{untimed}} \M$,
and thus the untimed teacher can also return a result \emph{yes}.
If the timed teacher answers \emph{no} and returns a counterexample $w$,
then $w$ is a transparent timed word of $\M$ but not of $\CH$.
In this case, by Theorem~\ref{untimedimpliestimed}, we may conclude that
$\CH \not\approx_{\mathit{untimed}} \M$, and thus the untimed teacher can also return a result \emph{no}.
Since $w$ is a transparent timed word of $\M$, it 
\iflong
follows by Lemma~\ref{lemma unique causality map} that $w$ 
\fi
has a unique causality map $c$.
This allows us to transform $w$ into an untimed input sequence $u$: 
we remove all the delays and output events, and if the $j$-th
input in $w$ equals $\mathit{to}$, we replace it by $\toevent{x_{c(j)}}$.
The untimed teacher performs an untimed membership query for $u$, and returns the resulting 
untimed behavior $\beta$ as counterexample.






